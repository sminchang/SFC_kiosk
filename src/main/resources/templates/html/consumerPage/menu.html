<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="MinChang Sung, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.104.2">
    <title>menu</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/5.2/examples/album/">

    <link rel="stylesheet" href="../../bottstrap-5.2.3/dist/css/bootstrap.min.css">

    <style>
        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        .nav-scroller .nav {
            display: flex;
            flex-wrap: nowrap;
            padding-bottom: 1rem;
            margin-top: -1px;
            overflow-x: auto;
            text-align: center;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
    </style>


</head>
<body>
<div class="container">
    <header class="d-flex justify-content-center py-3 bg-white fixed-top">
        <a href="/backHome" id="doubleClickLink" class="navbar-brand d-flex text-white align-items-center me-5">
            back</a>
        <ul class="nav nav-pills">
            <li class="nav-item"><a data-category="fastMenu" class="nav-link">fast menu</a></li>
            <li th:each="category : ${categorys}" class="nav-item">
                <a th:data-category="${category.categoryName}" class="nav-link" th:text="${category.categoryName}"></a>
            </li>
        </ul>
        <button type="button" class="btn btn-outline-secondary ms-5" data-bs-toggle="modal" data-bs-target="#cartModal">your cart</button>
    </header>
</div>

<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="cartModalLabel">your cart</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="orderForm" action="/new/order" th:object="${orderForm}" method="post">
                    <ul class="list-group mb-3" id="cartItems">
                        <li th:each="orderItem, itemStat : *{orderItems}" class="list-group-item d-flex justify-content-between align-items-center">
                            <input type="hidden" th:field="*{orderItems[__${itemStat.index}__].menuItemId}">
                            <input type="hidden" th:field="*{orderItems[__${itemStat.index}__].quantity}">
                        </li>
                    </ul>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Total (KRW)</span>
                        <strong id="total-price">₩0</strong>
                    </li>
                    <hr class="my-4">
                    <h4 class="mb-3">Payment</h4>
                    <div class="my-3">
                        <div class="form-check">
                            <input id="credit" name="paymentMethod" type="radio" class="form-check-input" checked required>
                            <label class="form-check-label" for="credit">Credit card</label>
                        </div>
                        <div class="form-check">
                            <input id="debit" name="paymentMethod" type="radio" class="form-check-input" required>
                            <label class="form-check-label" for="debit">Debit card</label>
                        </div>
                        <div class="form-check">
                            <input id="paypal" name="paymentMethod" type="radio" class="form-check-input" required>
                            <label class="form-check-label" for="paypal">PayPal</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">payment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<main>
    <div class="album py-5 bg-light">
        <div class="container pt-5">

            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
                <div class="col" th:each="menu : ${menus}">
                    <div class="card shadow-sm">
                        <img th:src="@{${menu.imagePath}}" class="bd-placeholder-img card-img-top" alt="Thumbnail" style="width: 100%; height: 225px; object-fit: cover;">
                        <div class="card-body">
                            <p class="card-text" th:text="${menu.menuName}"></p>
                            <p class="card-text" th:text="${menu.price}">₩</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="bottom" th:data-bs-content="${menu.description}">View</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary add-button" th:attr="onclick='addToCart({ id: \'' + ${menu.id} + '\', menuName: \'' + ${menu.menuName} + '\', price: \'' + ${menu.price} + '\' })'">Add</button></div>
                                <small class="text-muted" th:text="${menu.eventTime} > 0 ? ${menu.eventTime} + 'mins' : ${menu.defaultTime} + 'mins'"></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="../../bottstrap-5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 모든 nav-link에 대한 이벤트 리스너 추가
    document.querySelectorAll('.nav-link').forEach(item => {
        item.addEventListener('mouseover', (event) => {
            // 마우스 오버 시 active 클래스 추가
            event.target.classList.add('active');
        });
        item.addEventListener('mouseout', (event) => {
            // 마우스 아웃 시 active 클래스 제거
            event.target.classList.remove('active');
        });
    });
</script>

<script>
    document.getElementById('doubleClickLink').addEventListener('dblclick', function(e) {
        // 더블 클릭 이벤트 발생 시 로직
        window.location.href = this.href; // href 속성의 URL로 이동
    });

    // 기본 클릭 이벤트에서는 페이지 이동을 방지
    document.getElementById('doubleClickLink').addEventListener('click', function(e) {
        e.preventDefault(); // 기본 이벤트(링크 이동)를 방지
    });

    //카테고리 링크 클릭 이벤트 리스너
    document.querySelectorAll('.nav-link[data-category]').forEach(item => {
        item.addEventListener('click', (event) => {
            event.preventDefault();
            const category = event.target.getAttribute('data-category');
            fetchMenuItems(category);
        });
    });

    //초기 카테고리 로드
    document.addEventListener('DOMContentLoaded', () => {
        const initialCategory = document.querySelector('.nav-link[data-category]').getAttribute('data-category');
        fetchMenuItems(initialCategory);
    });

</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    let products = {};

    function updateQuantity(menuItemId, quantity) {
        const inputElement = document.querySelector(`input[value="${menuItemId}"]`);
        const orderItemInput = inputElement.nextElementSibling;
        orderItemInput.value = quantity;
    }

    function decrementQuantity(event, menuItemId, price) {
        event.stopPropagation();
        event.preventDefault();

        if (products[menuItemId].quantity > 1) {
            products[menuItemId].quantity--;
        }

        document.getElementById(`quantity-${menuItemId}`).textContent = products[menuItemId].quantity;
        updatePrice(menuItemId);
        updateTotalPrice();

        updateQuantity(menuItemId, products[menuItemId].quantity);

        const itemElement = document.getElementById(`cart-item-${menuItemId}`);
        const quantityInput = itemElement.querySelector('input[name$="].quantity"]');
        quantityInput.value = products[menuItemId].quantity;
    }

    function incrementQuantity(event, menuItemId, price) {
        event.stopPropagation();
        event.preventDefault();

        products[menuItemId].quantity++;

        document.getElementById(`quantity-${menuItemId}`).textContent = products[menuItemId].quantity;
        updatePrice(menuItemId);
        updateTotalPrice();

        updateQuantity(menuItemId, products[menuItemId].quantity);

        const itemElement = document.getElementById(`cart-item-${menuItemId}`);
        const quantityInput = itemElement.querySelector('input[name$="].quantity"]');
        quantityInput.value = products[menuItemId].quantity;
    }

    function updatePrice(menuItemId) {
        const price = products[menuItemId].price * products[menuItemId].quantity;
        document.getElementById(`price-${menuItemId}`).textContent = `₩${price}`;
    }

    function updateTotalPrice() {
        let total = 0;
        for (const menuItemId in products) {
            total += products[menuItemId].price * products[menuItemId].quantity;
        }
        document.getElementById('total-price').textContent = `₩${total}`;
    }
    /*]]>*/
</script>

<script>

    function fetchMenuItems(category) {
        fetch(`/menu/category/${category}`)
            .then(response => response.json())
            .then(data => {
                updateMenuItems(data);

                // 현재 열려 있는 팝오버 모두 숨기기
                const openPopovers = document.querySelectorAll('.popover.show');
                openPopovers.forEach(popover => {
                    popover.remove();
                });

                //팝오버 초기화
                const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
                [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function updateMenuItems(menuItems) {
        const menuContainer = document.querySelector('.row.row-cols-1.row-cols-sm-2.row-cols-md-3.g-3');
        menuContainer.innerHTML = '';

        menuItems.forEach(menuItem => {
            const menuElement = createMenuElement(menuItem);
            menuContainer.appendChild(menuElement);
        });
    }

    function createMenuElement(menuItem) {
        const colElement = document.createElement('div');
        colElement.classList.add('col');

        const cardElement = document.createElement('div');
        cardElement.classList.add('card', 'shadow-sm');

        const imageElement = document.createElement('img');
        imageElement.src = menuItem.imagePath;
        imageElement.classList.add('bd-placeholder-img', 'card-img-top');
        imageElement.alt = 'Thumbnail';
        imageElement.style.width = '100%';
        imageElement.style.height = '225px';
        imageElement.style.objectFit = 'cover';

        const cardBodyElement = document.createElement('div');
        cardBodyElement.classList.add('card-body');

        const menuNameElement = document.createElement('p');
        menuNameElement.classList.add('card-text');
        menuNameElement.textContent = menuItem.menuName;

        const priceElement = document.createElement('p');
        priceElement.classList.add('card-text');
        priceElement.textContent = `₩${menuItem.price}`;

        const buttonGroupElement = document.createElement('div');
        buttonGroupElement.classList.add('btn-group');

        const viewButtonElement = document.createElement('button');
        viewButtonElement.type = 'button';
        viewButtonElement.classList.add('btn', 'btn-sm', 'btn-outline-secondary');
        viewButtonElement.dataset.bsContainer = 'body';
        viewButtonElement.dataset.bsToggle = 'popover';
        viewButtonElement.dataset.bsPlacement = 'bottom';
        viewButtonElement.dataset.bsContent = `${menuItem.description}`;
        viewButtonElement.textContent = 'View';

        const addButtonElement = document.createElement('button');
        addButtonElement.type = 'button';
        addButtonElement.classList.add('btn', 'btn-sm', 'btn-outline-secondary');
        addButtonElement.setAttribute('onclick', `addToCart({ id: '${menuItem.id}', menuName: '${menuItem.menuName}', price: '${menuItem.price}' })`);
        addButtonElement.textContent = 'Add';

        const timeElement = document.createElement('small');
        timeElement.classList.add('text-muted');
        timeElement.textContent = menuItem.eventTime > 0 ? `${menuItem.eventTime} mins` : `${menuItem.defaultTime} mins`;

        buttonGroupElement.appendChild(viewButtonElement);
        buttonGroupElement.appendChild(addButtonElement);

        const buttonContainerElement = document.createElement('div');
        buttonContainerElement.classList.add('d-flex', 'justify-content-between', 'align-items-center');
        buttonContainerElement.appendChild(buttonGroupElement);
        buttonContainerElement.appendChild(timeElement);

        cardBodyElement.appendChild(menuNameElement);
        cardBodyElement.appendChild(priceElement);
        cardBodyElement.appendChild(buttonContainerElement);

        cardElement.appendChild(imageElement);
        cardElement.appendChild(cardBodyElement);

        colElement.appendChild(cardElement);

        return colElement;
    }

    function addToCart(menuItem) {
        const existingItem = document.getElementById(`cart-item-${menuItem.id}`);

        if (existingItem) {
            products[menuItem.id].quantity++;
            document.getElementById(`quantity-${menuItem.id}`).textContent = products[menuItem.id].quantity;
            updatePrice(menuItem.id);
            updateQuantity(menuItem.id, products[menuItem.id].quantity);
        } else {
            const cartItemsContainer = document.getElementById('cartItems');
            const itemElement = createCartItemElement(menuItem);
            cartItemsContainer.insertBefore(itemElement, cartItemsContainer.lastChild);
            products[menuItem.id] = {
                quantity: 1,
                price: menuItem.price
            };
        }

        updateCartInStorage(menuItem);
        showAddedConfirmation(menuItem);
        updateTotalPrice();
    }

    function updateCartInStorage(menuItem) {
        let cartItems = JSON.parse(sessionStorage.getItem('cartItems') || '[]');
        const existingItemIndex = cartItems.findIndex(item => item.id === menuItem.id);

        if (existingItemIndex !== -1) {
            cartItems[existingItemIndex].quantity = products[menuItem.id].quantity;
        } else {
            cartItems.push({ ...menuItem, quantity: 1 });
        }

        sessionStorage.setItem('cartItems', JSON.stringify(cartItems));
    }

    function showAddedConfirmation(menuItem) {
        const addButton = document.querySelector(`button[onclick="addToCart({ id: '${menuItem.id}', menuName: '${menuItem.menuName}', price: '${menuItem.price}' })"]`);
        const popover = new bootstrap.Popover(addButton, {
            content: '메뉴가 추가되었습니다.',
            trigger: 'manual',
            placement: 'bottom'
        });

        popover.show();
        setTimeout(() => popover.hide(), 1000);
    }

    function removeToCart(event, menuItemId) {
        event.stopPropagation();
        event.preventDefault();

        const itemElement = document.getElementById(`cart-item-${menuItemId}`);
        itemElement.remove();

        let cartItems = JSON.parse(sessionStorage.getItem('cartItems') || '[]');
        cartItems = cartItems.filter(item => item.id !== menuItemId);
        sessionStorage.setItem('cartItems', JSON.stringify(cartItems));

        delete products[menuItemId];

        updateTotalPrice();
    }
    function createCartItemElement(menuItem) {
        const itemElement = document.createElement('li');
        itemElement.id = `cart-item-${menuItem.id}`;
        itemElement.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');

        const nameElement = document.createElement('div');
        nameElement.textContent = menuItem.menuName;
        nameElement.classList.add('me-auto'); // 메뉴 이름 길이에 상관없이 왼쪽에 고정

        const quantityElement = document.createElement('div');
        quantityElement.classList.add('d-flex', 'align-items-center'); // 수량 부분 가운데 정렬

        const decrementButton = document.createElement('button');
        decrementButton.classList.add('btn', 'btn-sm', 'btn-outline-secondary');
        decrementButton.textContent = '-';
        decrementButton.addEventListener('click', (event) => decrementQuantity(event, menuItem.id, menuItem.price));

        const quantitySpan = document.createElement('span');
        quantitySpan.id = `quantity-${menuItem.id}`;
        quantitySpan.classList.add('mx-2'); // 수량 양쪽 여백 조절
        quantitySpan.textContent = '1';

        const incrementButton = document.createElement('button');
        incrementButton.classList.add('btn', 'btn-sm', 'btn-outline-secondary');
        incrementButton.textContent = '+';
        incrementButton.addEventListener('click', (event) => incrementQuantity(event, menuItem.id, menuItem.price));

        quantityElement.appendChild(decrementButton);
        quantityElement.appendChild(quantitySpan);
        quantityElement.appendChild(incrementButton);

        const priceElement = document.createElement('span');
        priceElement.id = `price-${menuItem.id}`;
        priceElement.classList.add('text-body-secondary', 'ms-2'); // 가격 왼쪽 여백 추가
        priceElement.textContent = `₩${menuItem.price}`;

        const removeButton = document.createElement('button');
        removeButton.classList.add('btn', 'btn-sm', 'btn-outline-secondary', 'ms-2'); // 제거 버튼 왼쪽 여백 추가
        removeButton.textContent = 'x';
        removeButton.addEventListener('click', (event) => removeToCart(event, menuItem.id));

        const menuItemIdInput = document.createElement('input');
        menuItemIdInput.type = 'hidden';
        menuItemIdInput.name = 'orderItems[' + (document.querySelectorAll('#cartItems li').length) + '].menuItemId';
        menuItemIdInput.value = menuItem.id;

        const quantityInput = document.createElement('input');
        quantityInput.type = 'hidden';
        quantityInput.name = 'orderItems[' + (document.querySelectorAll('#cartItems li').length) + '].quantity';
        quantityInput.value = 1;

        itemElement.appendChild(nameElement);
        itemElement.appendChild(quantityElement);
        itemElement.appendChild(priceElement);
        itemElement.appendChild(removeButton);
        itemElement.appendChild(menuItemIdInput);
        itemElement.appendChild(quantityInput);

        return itemElement;
    }
</script>

</body>
</html>
